# gitlab Cookbook

Configures the different components needed for an Omnibus installation of GitLab

## Resources (CE)

### postgresql_user

Creates a user account in the PostgreSQL instance

#### properties

* `username`: The name of the user to create. Required
* `password`: The password of the account. Optional. This can be the plaintext password, or an md5 hash of the password. The hash can be generated by running `echo -n 'PASSWORD+USERNAME' | md5sum` and should be passed in the form `md5PASSWORD_HASH`.
* `options`: An array of options to enable on the user. Optional. See the [PostgreSQL documentation](https://www.postgresql.org/docs/11/static/sql-createuser.html) for the available options
* `helper`: The helper object for interacting with the running database. Default: PgHelper.new(node)

#### example

Create the user 'bar' without a password or any options

```ruby
postgresql_user 'bar'
```

Create the superuser 'bar' with an md5 encoded password
```ruby
postgresql_user 'bar' do
  options %w(SUPERUSER)
  password 'md5........'
end
```

### postgresql_database

Creates a database in the PostgreSQL instance

#### properties

* `database`: The name of the database to create. Required.
* `owner`: The user account that will be the owner of the database. Default: `node['postgresql']['user']`
* `helper`: The helper object for interacting with the running database. Default: PgHelper.new(node)
* `database_port`: The port the database instance is listening on. Default: `node['postgresql']['port']`
* `database_socket`: The directory that the socket file exists in. Default: `node['postgresql']['unix_socket_directory']`

#### example

Create a database called 'foo' owned by the default postgresql user

```ruby
postgresql_database 'foo'
```

Create a database called 'foo' owned by user 'bar'

```ruby
postgresql_database 'foo' do
  owner 'bar'
end
```

### postgresql_query

Utility resource to execute administrative queries against the PostgreSQL instance.
This resource is used by other resources to CREATE, UPDATE and DESTROY data in the database.

#### properties

* `description`: (name property): Textual identification of the operation (must be unique)
* `query`: The SQL query that must be executed in the database
* `db_name`: The database where the queries are going to run. Default: `template1`
* `helper`: The helper object for interacting with the running database. Default: PgHelper.new(node)

#### example

```ruby
postgresql_query 'creates gitlab user' do
  query "CREATE USER 'gitlab';"
end
```

## Resources (EE)

### pgbouncer_user

Creates and configures a pgbouncer user

#### properties

`type` (name property): The identifier
`account_helper`: defaults to AccountHelper.new(node)
`add_auth_function`: whether or not to add the auth function, true or false.
`database`: name of the db
`password`: pgobuncer password
`pg_helper`: defaults to PgHelper.new(node)
`user`: pgbouncer username

#### example

```
pgbouncer_user 'rails' do
  pgbouncer_user 'pgbouncer'
  pgbouncer_user_password 'password'
  db_database 'gitlabhq_production'
  cmd "/opt/gitlab/bin/gitlab-psql"
  add_auth_function 'yes'
  action :create
end
```

### postgresql_fdw

Creates a FOREIGN DATA WRAPPER ([FDW]) [connection][FDW-CONNECTION] in PostgreSQL to another PostgreSQL instance

#### properties

* `server_name` (name property): The identifier that will be used in PostgreSQL to refer to this connection
* `db_host`: The host of the remote instance
* `db_port`: The port of the remote instance
* `db_name`: The database name of the remote instance

#### example

Create a Foreign Data Wrapper connection with an external PostgreSQL instance

```ruby
postgresql_fdw 'gitlab_secondary' do
  db_host '10.0.0.1'
  db_port 5432
  db_name 'otherdb'
  action :create
end

```

### postgresql_fdw_user_mapping

Creates a user mapping for a local user to be able to connect to a remote database as a remote user.

This is how loca user can interact with an external [FDW] configured instance.

#### properties

* `server_name` (name property): The identifier that will be used in PostgreSQL to refer to this connection
* `db_user`: The local user that will be mapped to a remote one
* `db_name`: The local database name where the mapping will happen
* `external_user`: The remote user that will be mapped to the local one
* `external_password`: The password for the remote user, that local database will use to connect
* `helper`: The helper object for interacting with the running database. Default: PgHelper.new(node)

```ruby
postgresql_fdw_user_mapping 'gitlab_secondary' do
  db_user 'user'
  db_name 'database'
  external_user 'remoteuser'
  external_password 'remotepassword'
  action :create
end
```

[FDW]: https://www.postgresql.org/docs/11/postgres-fdw.html
[FDW-CONNECTION]: https://www.postgresql.org/docs/11/sql-createserver.html
