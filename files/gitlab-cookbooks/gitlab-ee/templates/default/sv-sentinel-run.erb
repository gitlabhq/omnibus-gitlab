#!/bin/sh
exec 2>&1
<%= render('mount_point_check.erb', cookbook: 'gitlab') %>
umask 077

<% user = @options[:user] %>
<% group = @options[:groupname] %>
<% if node['redis']['backend'] == 'valkey' %>
<%   sentinel_cmd = '/opt/gitlab/embedded/bin/valkey-sentinel' %>
<% else %>
<%   sentinel_cmd = '/opt/gitlab/embedded/bin/redis-sentinel' %>
<% end %>
exec chpst -P \
  -U <%= user %>:<%= group %> \
  -u <%= user %>:<%= group %> \
  <%= sentinel_cmd %> \
  <%= @options[:config_path] %><% if node['redis']['announce_ip_from_hostname'] %> \
  '--sentinel announce-ip' "$(hostname -f)"<% end %>
